select playerP2, playerT2, rate from (select playerP2 as playerP2, raceP, playerT2 as playerT2, if (sum(PwinT)/count(*) > 0.65, sum(PwinT)/count(*),0) as rate,  if (sum(totalmatch) > 10, sum(totalmatch),0) as finalmatch from (select playerP2 as playerP2, raceP as raceP, scoreP as scoreP, scoreT as scoreT, playerT2 as playerT2, raceT as raceT, if (scoreP > scoreT, 1, 0) as PwinT, Concat(scoreP+scoreT) as totalmatch from (select playerA as playerP2, raceA as raceP, scoreA as scoreP, scoreB as scoreT, playerB as playerT2, game_race as raceT from (select playerA as playerA, game_race as raceA, playerB as playerB, scoreA as scoreA, scoreB as scoreB from matches inner join players on matches.playerA = players.player_id and players.game_race = "P") honors inner join players on players.player_id = honors.playerB and players.game_race = "T" union select playerB as playerP2, raceB as raceP, scoreB as scoreP, scoreA as scoreT, playerA as playerT2, game_race as raceT from (select playerB as playerB, game_race as raceB, playerA as playerA, scoreA as scoreA, scoreB as scoreB from matches inner join players on matches.playerB = players.player_id and players.game_race = "P") honors inner join players on players.player_id = honors.playerA and players.game_race = "T") honors9 ) honors10 group by playerP2, playerT2) honors11 where rate != 0 and finalmatch != 0
